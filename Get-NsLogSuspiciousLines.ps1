<#
Sebastian Bammer-Tasch 20.11.2023
https://www.mandiant.com/resources/blog/session-hijacking-citrix-cve-2023-4966
According to Madiant, a potential IOC seems to be that the client_ip in netscaler log ns.log does not match the source.
This script extracts all ns.log gzip files using 7zip, and searches for this information. These are then written to "C:\Logs\netscaler_clientIp-not-equal-to-source.txt".
#>

# The directory that contains the log-rotated netscaler log gzip files. You can also put the log files themself here (e.g. ns.log.1, ns.log.2, ...)
$files = dir @("C:\Logs\Citrix\*.gz")
$outFile = "C:\Logs\netscaler_clientIp-not-equal-to-source.csv"

foreach ($f in $files) {
  & 'C:\Program Files\7-Zip\7z.exe' e $f.FullName -o"$($f.FullName.Replace('.gz',''))$(Get-Random)"
}

$OutCol = New-Object System.Collections.ArrayList

foreach ($f in @(dir "C:\Logs\Citrix\" -Recurse)) {
    if ($f.Name -like 'ns.log.*' -and $f.Name -notlike '*.gz') {
        #$c =  @(Get-Content $f.FullName -raw)
        $c =  @(Get-Content $f.FullName)
        foreach ($l in $c) {
            $re = [regex]::new("- Client_ip ((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).*Source ((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)")
            #$m = $re.Matches($c)
            $m = $re.Matches($l)
            foreach ($v in $m.value) {
                $data = $v.split("-")
                $clientIP = $data[1].Trim().split(" ")[-1]
                $source = $data[-1].Trim().split(" ")[-1]
                if ($clientIP -ne $source) {
                   $outObj =  New-Object PSCustomObject
                   $outObj | Add-Member -MemberType NoteProperty -Name clientIp -Value $clientIP
                   $outObj | Add-Member -MemberType NoteProperty -Name source -Value $source
                   $outObj | Add-Member -MemberType NoteProperty -Name originalLogLine -Value $l
                   [void]$OutCol.Add($outObj)
                }
            }
        }
    }
}

$OutCol | Export-Csv -Path $outFile -NoClobber -NoTypeInformation
